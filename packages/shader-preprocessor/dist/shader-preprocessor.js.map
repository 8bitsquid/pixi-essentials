{"version":3,"file":"shader-preprocessor.js","sources":["../src/ProgramTemplate.ts","../src/ShaderPreprocessor.ts"],"sourcesContent":["import { Program } from '@pixi/core';\n\ntype TemplateData = Array<{\n    id: string;\n    args: string[];\n    position: { start: number; end: number };\n    type: 'field' | 'function';\n}>;\n\nexport type MacroData = {\n    [id: string]: string | ((...args: string[]) => string);\n};\n\nconst MACRO_PATTERN = /%([\\w$]+)(\\([\\w$, ]*\\))?%/g;\n\n/**\n * Helper class to create and manage a program template.\n *\n * @public\n */\nexport class ProgramTemplate\n{\n    public vertexTemplateSrc: string;\n    public fragmentTemplateSrc: string;\n    public name: string;\n\n    protected programCache: Map<string, Program>;\n    protected vertexMacroData: TemplateData;\n    protected fragmentMacroData: TemplateData;\n\n    /**\n     * @param vertexTemplateSrc - vertex shader template\n     * @param fragmentTemplateSrc - fragment shader template\n     * @param name - name of the shader template. This is used to generate the names for generated programs.\n     */\n    constructor(vertexTemplateSrc?: string, fragmentTemplateSrc?: string, name = 'pixi-shader-template')\n    {\n        /**\n         * The vertex shader template\n         */\n        this.vertexTemplateSrc = vertexTemplateSrc || Program.defaultVertexSrc;\n\n        /**\n         * The fragment shader template\n         */\n        this.fragmentTemplateSrc = fragmentTemplateSrc || Program.defaultFragmentSrc;\n\n        /**\n         * The name for generated programs\n         */\n        this.name = name;\n\n        /**\n         * The cache of generated programs for each passed macro value.\n         */\n        this.programCache = new Map<string, Program>();\n\n        /**\n         * The macros used in the vertex shader\n         */\n        this.vertexMacroData = this.extractData(this.vertexTemplateSrc);\n\n        /**\n         * The macros used in the fragment shader\n         */\n        this.fragmentMacroData = this.extractData(this.fragmentTemplateSrc);\n    }\n\n    /**\n     * Generates a shader program from this template and passed macro-data.\n     *\n     * @param data - data providing the values of the macros in the shader template\n     * @param name - optional name, if another name is desired\n     * @return the generated shader program\n     */\n    generateProgram(data: MacroData, name: string): Program\n    {\n        const vertexSrc = this.processData(this.vertexTemplateSrc, this.vertexMacroData, data);\n        const fragmentSrc = this.processData(this.fragmentTemplateSrc, this.fragmentMacroData, data);\n        const key = vertexSrc + fragmentSrc;\n        const memo = this.programCache.get(key);\n\n        if (memo)\n        {\n            return memo;\n        }\n\n        const program = new Program(vertexSrc, fragmentSrc, name || this.name || 'pixi-processed-shader');\n\n        this.programCache.set(key, program);\n\n        return program;\n    }\n\n    /**\n     * Extracts the macros used in the template source.\n     *\n     * @param templateSrc - the shader template source\n     */\n    protected extractData(templateSrc: string): TemplateData\n    {\n        const data = [];\n        const pattern = new RegExp(MACRO_PATTERN);\n\n        let macroMatch;\n\n        while ((macroMatch = pattern.exec(templateSrc)) !== null)\n        {\n            const id = macroMatch[1];\n            let args = macroMatch[2];\n\n            if (args)\n            {\n                args = args.slice(1, -1).split(',').map((arg) => arg.trim());\n            }\n\n            data.push({\n                id,\n                args,\n                position: { start: macroMatch.index, end: macroMatch.index + macroMatch[0].length },\n                type: args ? 'function' : 'field',\n            });\n        }\n\n        return data;\n    }\n\n    /**\n     * Evaluates the macros in the template and generates the shader's source.\n     *\n     * @param templateSrc - template source\n     * @param macros - data defining the macros in the template source\n     * @param data - data providing the values for the macros\n     * @return the generated shader source\n     */\n    protected processData(templateSrc: string, macros: TemplateData, data: MacroData): string\n    {\n        let generatedSrc = templateSrc;\n\n        // Process the last macros first so that positions of the unevaluated macros don't change\n        for (let i = macros.length - 1; i >= 0; i--)\n        {\n            const macro = macros[i];\n            const id = macro.id;\n            const value = data[id];\n\n            let macroValue = '';\n\n            if (typeof value === 'function')\n            {\n                macroValue = value(...macro.args);\n            }\n            else\n            {\n                // Coerce the value to a string\n                macroValue = `${value}`;\n            }\n\n            generatedSrc = generatedSrc.slice(0, macro.position.start)\n                + macroValue\n                + generatedSrc.slice(macro.position.end);\n        }\n\n        return generatedSrc;\n    }\n}\n","import { MacroData, ProgramTemplate } from './ProgramTemplate';\nimport { Shader } from '@pixi/core';\n\n/**\n * Provides a high-level API to manage program template and generate shaders by passing macro data\n * for the shader templates.\n *\n * @public\n */\nexport class ShaderPreprocessor\n{\n    /**\n     * @param vertexTemplateSrc - the vertex shader template source\n     * @param fragmentTemplateSrc  - the fragment shader template source\n     * @param name - custom name of the shader, if desired\n     */\n    static generateShader(vertexTemplateSrc: string,\n        fragmentTemplateSrc: string,\n        uniforms: Record<string, any>,\n        data: MacroData, name?: string): Shader\n    {\n        const programTemplate = ShaderPreprocessor.from(vertexTemplateSrc, fragmentTemplateSrc, name);\n        const program = programTemplate.generateProgram(data, name);\n\n        return new Shader(program, uniforms);\n    }\n\n    /**\n     * Creates a program template for given shader template sources. It will return a memoized instance if\n     * the same sources are used together twice.\n     *\n     * @param vertexTemplateSrc - vertex template source\n     * @param fragmentTemplateSrc - fragment template source\n     * @param name - the name of the template\n     */\n    static from(vertexTemplateSrc: string, fragmentTemplateSrc: string, name?: string): ProgramTemplate\n    {\n        const key = vertexTemplateSrc + fragmentTemplateSrc;\n        let template = ShaderPreprocessor.managedTemplates[key];\n\n        if (!template)\n        {\n            template\n                = ShaderPreprocessor.managedTemplates[key]\n                = new ProgramTemplate(vertexTemplateSrc, fragmentTemplateSrc, name);\n        }\n\n        return template;\n    }\n\n    static managedTemplates: { [id: string]: ProgramTemplate } = {};\n}\n"],"names":["Program","Shader"],"mappings":"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"}