{"version":3,"file":"cull.js","sources":["../src/Cull.ts"],"sourcesContent":["import type { DisplayObject } from 'pixi.js';\nimport { Rectangle } from 'pixi.js';\n\nconst tempRect = new Rectangle();\n\ninterface ICullOptions\n{\n    toggle: 'visible' | 'renderable';\n}\n\n/**\n * WIP: Better culling than pixi-cull\n */\nexport class Cull\n{\n    private _toggle: 'visible' | 'renderable';\n\n    private _targetList: Set<DisplayObject>;\n\n    constructor(options: Partial<ICullOptions> = {})\n    {\n        this._toggle = options.toggle || 'visible';\n        this._targetList = new Set<DisplayObject>();\n    }\n\n    add(target: DisplayObject): void\n    {\n        this._targetList.add(target);\n    }\n\n    addAll(targets: DisplayObject[]): void\n    {\n        for (let i = 0, j = targets.length; i < j; i++)\n        {\n            this._targetList.add(targets[i]);\n        }\n    }\n\n    remove(target: DisplayObject): void\n    {\n        this._targetList.delete(target);\n    }\n\n    removeAll(targets: DisplayObject[]): void\n    {\n        for (let i = 0, j = targets.length; i < j; i++)\n        {\n            this._targetList.delete(targets[i]);\n        }\n    }\n\n    clear(): void\n    {\n        this._targetList.clear();\n    }\n\n    /**\n     * @param rect - the rectangle outside of which display-objects should be culled\n     * @param skipUpdate - whether to skip transform update\n     */\n    cull(rect: Rectangle, skipUpdate = false): void\n    {\n        this._targetList.forEach((target) =>\n        {\n            if (!skipUpdate)\n            {\n                const parent = target.parent;\n\n                // TODO: pixi.js 5.3.0 use enableTempParent()\n                if (!target.parent)\n                {\n                    target.parent = target._tempDisplayObjectParent;\n                }\n\n                target.updateTransform();\n                target.parent = parent;\n            }\n\n            this.cullRecursive(rect, target);\n        });\n    }\n\n    protected cullRecursive(rect: Rectangle, displayObject: DisplayObject): void\n    {\n        // NOTE: getBounds can skipUpdate because updateTransform is invoked before culling.\n        const bounds = displayObject.getBounds(true, tempRect);\n\n        displayObject[this._toggle] = bounds.right > rect.left\n            && bounds.left < rect.right\n            && bounds.bottom > rect.top\n            && bounds.top < rect.bottom;\n\n        // Only cull children if this display-object is visible. It is expected that the bounds\n        // of children lie inside of its own.\n        if (displayObject[this._toggle])\n        {\n            this.cullRecursive(rect, displayObject);\n        }\n    }\n}\n"],"names":["Rectangle"],"mappings":";;;;;;;;;;;;;AAGA,IAAM,QAAQ,GAAG,IAAIA,iBAAS,EAAE,CAAC;AAOjC;;;;IASI,cAAY,OAAmC;QAAnC,wBAAA,EAAA,YAAmC;QAE3C,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC,MAAM,IAAI,SAAS,CAAC;QAC3C,IAAI,CAAC,WAAW,GAAG,IAAI,GAAG,EAAiB,CAAC;KAC/C;IAED,kBAAG,GAAH,UAAI,MAAqB;QAErB,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;KAChC;IAED,qBAAM,GAAN,UAAO,OAAwB;QAE3B,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,EAC9C;YACI,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC;SACpC;KACJ;IAED,qBAAM,GAAN,UAAO,MAAqB;QAExB,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;KACnC;IAED,wBAAS,GAAT,UAAU,OAAwB;QAE9B,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,EAC9C;YACI,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC;SACvC;KACJ;IAED,oBAAK,GAAL;QAEI,IAAI,CAAC,WAAW,CAAC,KAAK,EAAE,CAAC;KAC5B;;;;;IAMD,mBAAI,GAAJ,UAAK,IAAe,EAAE,UAAkB;QAAxC,iBAoBC;QApBqB,2BAAA,EAAA,kBAAkB;QAEpC,IAAI,CAAC,WAAW,CAAC,OAAO,CAAC,UAAC,MAAM;YAE5B,IAAI,CAAC,UAAU,EACf;gBACI,IAAM,MAAM,GAAG,MAAM,CAAC,MAAM,CAAC;;gBAG7B,IAAI,CAAC,MAAM,CAAC,MAAM,EAClB;oBACI,MAAM,CAAC,MAAM,GAAG,MAAM,CAAC,wBAAwB,CAAC;iBACnD;gBAED,MAAM,CAAC,eAAe,EAAE,CAAC;gBACzB,MAAM,CAAC,MAAM,GAAG,MAAM,CAAC;aAC1B;YAED,KAAI,CAAC,aAAa,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;SACpC,CAAC,CAAC;KACN;IAES,4BAAa,GAAvB,UAAwB,IAAe,EAAE,aAA4B;;QAGjE,IAAM,MAAM,GAAG,aAAa,CAAC,SAAS,CAAC,IAAI,EAAE,QAAQ,CAAC,CAAC;QAEvD,aAAa,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,MAAM,CAAC,KAAK,GAAG,IAAI,CAAC,IAAI;eAC/C,MAAM,CAAC,IAAI,GAAG,IAAI,CAAC,KAAK;eACxB,MAAM,CAAC,MAAM,GAAG,IAAI,CAAC,GAAG;eACxB,MAAM,CAAC,GAAG,GAAG,IAAI,CAAC,MAAM,CAAC;;;QAIhC,IAAI,aAAa,CAAC,IAAI,CAAC,OAAO,CAAC,EAC/B;YACI,IAAI,CAAC,aAAa,CAAC,IAAI,EAAE,aAAa,CAAC,CAAC;SAC3C;KACJ;IACL,WAAC;AAAD,CAAC;;;;"}